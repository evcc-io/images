#!/usr/bin/env bash
set -euo pipefail

# Install Caddy
apt-get install -y --no-install-recommends caddy

# Caddy configuration with internal TLS and reverse proxy to evcc:80
mkdir -p /etc/caddy
cat >/etc/caddy/Caddyfile <<CADDY
{
  email admin@example.com
  auto_https disable_redirects
}

# HTTPS on 443 with Caddy internal TLS
${EVCC_HOSTNAME}.local:443 {
  tls internal
  encode zstd gzip
  log
  reverse_proxy 127.0.0.1:80
}

CADDY

# Enable Caddy service
systemctl enable caddy || true


